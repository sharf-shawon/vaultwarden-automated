version: '3.8'

services:
  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    restart: always
    environment:
      - DOMAIN=${SERVICE_URL_VAULTWARDEN}
      - DATABASE_URL=${VAULTWARDEN_DB_URL:-/data/db.sqlite3}
      - SIGNUPS_ALLOWED=${SIGNUP_ALLOWED:-false}
      - ADMIN_TOKEN=${SERVICE_PASSWORD_64_ADMIN}
      - IP_HEADER=${IP_HEADER:-CF-Connecting-IP}
      - PUSH_ENABLED=${PUSH_ENABLED:-false}
      - PUSH_INSTALLATION_ID=${PUSH_SERVICE_ID:-}
      - PUSH_INSTALLATION_KEY=${PUSH_SERVICE_KEY:-}
      - ROCKET_PORT=80
      - WEBSOCKET_ENABLED=true
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - EXTENDED_LOGGING=${EXTENDED_LOGGING:-true}
      - SHOW_PASSWORD_HINT=${SHOW_PASSWORD_HINT:-false}
      - INVITATIONS_ALLOWED=${INVITATIONS_ALLOWED:-true}
      - EMERGENCY_ACCESS_ALLOWED=${EMERGENCY_ACCESS_ALLOWED:-true}
    volumes:
      - vaultwarden-data:/data
    # ports:
      # - "${VAULTWARDEN_PORT:-8080}:80"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:80/alive"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "backup.enable=true"
    networks:
      - vaultwarden-network

  backup:
    image: offen/docker-volume-backup:v2
    container_name: vaultwarden-backup
    restart: unless-stopped
    environment:
      # Backup schedule (daily at 2 AM)
      - BACKUP_CRON_EXPRESSION=${BACKUP_CRON:-0 2 * * *}
      
      # S3 Configuration
      - AWS_S3_BUCKET_NAME=${S3_BUCKET_NAME:?}
      - AWS_ACCESS_KEY_ID=${S3_ACCESS_KEY:?}
      - AWS_SECRET_ACCESS_KEY=${S3_SECRET_KEY:?}
      - AWS_S3_PATH=${S3_PATH:?/vaultwarden-backups}
      - AWS_ENDPOINT=${S3_ENDPOINT:?}
      - AWS_ENDPOINT_PROTO=${S3_ENDPOINT_PROTO:?https}
      
      # Backup configuration
      - BACKUP_FILENAME=${BACKUP_FILENAME:-vaultwarden-backup-%Y-%m-%dT%H-%M-%S.tar.gz}
      - BACKUP_LATEST_SYMLINK=${BACKUP_LATEST_SYMLINK:-vaultwarden-backup-latest.tar.gz}
      - BACKUP_RETENTION_DAYS=${BACKUP_RETENTION_DAYS:-15}
      - BACKUP_PRUNING_LEEWAY=${BACKUP_PRUNING_LEEWAY:-1m}
      
      # Encryption
      - GPG_PASSPHRASE=${BACKUP_ENCRYPTION_KEY}
      
      # Compression
      - BACKUP_COMPRESSION=${BACKUP_COMPRESSION:-gz}
      
      # Notifications (optional)
      - NOTIFICATION_URLS=${BACKUP_NOTIFICATION_URLS:-}
      - NOTIFICATION_LEVEL=${BACKUP_NOTIFICATION_LEVEL:-error}
      
      # Backup verification
      - BACKUP_SKIP_BACKENDS_FROM_PRUNE=${BACKUP_SKIP_BACKENDS_FROM_PRUNE:-}
      
      # Stop containers during backup (optional, for consistency)
      # Stop containers during backup (optional, for consistency)
      - BACKUP_STOP_DURING_BACKUP_LABEL=${BACKUP_STOP_DURING_BACKUP:-backup.stop=true}
      
      # Exec commands (optional healthcheck)
      - EXEC_LABEL=backup.enable
      - EXEC_FORWARD_OUTPUT=${BACKUP_EXEC_FORWARD_OUTPUT:-true}
    volumes:
      - vaultwarden-data:/backup/vaultwarden-data:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - backup-cache:/tmp/backup
    depends_on:
      vaultwarden:
        condition: service_healthy
    labels:
      - "coolify.expose=false"
    networks:
      - vaultwarden-network

  watchtower:
    image: containrrr/watchtower:latest
    container_name: vaultwarden-watchtower
    restart: unless-stopped
    environment:
      - WATCHTOWER_SCOPE=${COMPOSE_PROJECT_NAME}
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=${WATCHTOWER_POLL_INTERVAL:-86400}
      - WATCHTOWER_ROLLING_RESTART=true
      - WATCHTOWER_INCLUDE_RESTARTING=true
      - WATCHTOWER_INCLUDE_STOPPED=false
      - WATCHTOWER_REVIVE_STOPPED=false
      - WATCHTOWER_NOTIFICATION_URL=${WATCHTOWER_NOTIFICATION_URL:-}
      - WATCHTOWER_NOTIFICATIONS_LEVEL=${WATCHTOWER_NOTIFICATION_LEVEL:-info}
      - TZ=${TZ:-UTC}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      - "coolify.expose=false"
    networks:
      - vaultwarden-network

volumes:
  vaultwarden-data:
    driver: local
  backup-cache:
    driver: local

networks:
  vaultwarden-network:
    driver: bridge
