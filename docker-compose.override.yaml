version: '3.8'

# This file provides overrides for local development or alternative configurations
# Rename to docker-compose.override.yml to activate

services:
  vaultwarden:
    # Uncomment to use external PostgreSQL database
    # environment:
    #   - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
    # depends_on:
    #   - postgres

  backup:
    # Override for local filesystem backups instead of S3
    # NOTE: When using this override, you must still provide placeholder values
    # for the required S3 variables in your .env file to prevent errors.
    # For example:
    # S3_BUCKET_NAME=local
    # S3_ACCESS_KEY=local
    # S3_SECRET_KEY=local
    # S3_PATH=local
    # S3_ENDPOINT=local
    environment:
      # Disable S3, enable local backup
      - BACKUP_ARCHIVE=/archive
    volumes:
      - vaultwarden-data:/backup/vaultwarden-data:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./backups:/archive
      - backup-cache:/tmp/backup

  # Uncomment for external PostgreSQL database
  # postgres:
  #   image: postgres:16-alpine
  #   container_name: vaultwarden-postgres
  #   restart: unless-stopped
  #   environment:
  #     - POSTGRES_USER=${POSTGRES_USER:-vaultwarden}
  #     - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
  #     - POSTGRES_DB=${POSTGRES_DB:-vaultwarden}
  #   volumes:
  #     - postgres-data:/var/lib/postgresql/data
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-vaultwarden}"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   networks:
  #     - vaultwarden-network
  #   labels:
  #     - "backup.enable=true"

  # Uncomment for reverse proxy with automatic SSL
  # caddy:
  #   image: caddy:2-alpine
  #   container_name: vaultwarden-caddy
  #   restart: unless-stopped
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     - ./Caddyfile:/etc/caddy/Caddyfile:ro
  #     - caddy-data:/data
  #     - caddy-config:/config
  #   environment:
  #     - DOMAIN=${SERVICE_URL_VAULTWARDEN}
  #   depends_on:
  #     - vaultwarden
  #   networks:
  #     - vaultwarden-network

# volumes:
#   postgres-data:
#     driver: local
#   caddy-data:
#     driver: local
#   caddy-config:
#     driver: local